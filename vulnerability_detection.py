import time
import tkinter as tk
import tkinter.messagebox as messagebox

from iot_network import IoTNetwork

# Initialize the IoTNetwork instance outside the function
iot_network = IoTNetwork()


def detect_vulnerability(device_id):
    # Replace this function with your own logic to detect vulnerabilities
    return True


def issue_detected():
    # Replace this function with your own logic to detect issues
    return True


def prompt_approval():
    root = tk.Tk()
    root.withdraw()
    approval = messagebox.askyesno("IoTShield",
                                   "IoTShield has detected a small issue. Please give authority to send this data.")
    root.destroy()
    return approval


def report_issue():
    # Replace this function with your own logic to report issues
    pass


def run_vulnerability_check():
    while True:
        for device in iot_network.devices.values():
            if detect_vulnerability(device.device_id):
                if not device.blocked:
                    print(f"Vulnerability detected! Blocking device {device.device_id}")
                    device.block_device()
            else:
                if device.blocked:
                    print(f"Vulnerability cleared! Unblocking device {device.device_id}")
                    device.unblock_device()

        time.sleep(5)  # Check for vulnerabilities every 5 seconds (or adjust the interval as needed)


# This part will only run if this module is executed directly (not imported)
if __name__ == "__main__":
    if issue_detected():
        if prompt_approval():
            report_issue()
    run_vulnerability_check()
